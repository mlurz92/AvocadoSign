# Anwendungsbeschreibung "Lymphknoten T2 - Avocado Sign Analyse" (v2.1.0)

## 1. Zweck und Kontext

Diese Webanwendung ist ein **spezialisiertes, interaktives Analysewerkzeug**, das für die Autoren der **Avocado-Sign Studie** (Lurz & Schäfer, Eur Radiol 2025) entwickelt wurde. Sie dient der **detaillierten explorativen Analyse und dem Vergleich** der diagnostischen Leistung des kontrastmittelbasierten Avocado Signs (AS) gegenüber verschiedenen **T2-gewichteten morphologischen Kriterien** zur Vorhersage des pathologischen mesorektalen Lymphknotenstatus (N-Status) bei Rektumkarzinompatienten.

Die Anwendung basiert auf dem **identischen Patientenkollektiv (N=106)** der genannten Studie und ermöglicht:

* Flexible Definition und Anwendung benutzerdefinierter T2-Kriteriensets.
* Automatisierte Optimierung von T2-Kriterien zur Maximierung diagnostischer Metriken.
* Direkten Vergleich von AS mit Literatur-basierten T2-Kriterien (Koh et al. 2008, Barbaro et al. 2024, Rutegård et al. 2025).
* Umfassende statistische Auswertung der diagnostischen Güte und Assoziationen.
* Generierung von **publikations- und präsentationsreifen** Tabellen, Diagrammen und Berichten.

Alle Analysen verwenden den **histopathologischen Befund** des Operationspräparats als Referenzstandard (Goldstandard) für den N-Status.

## 2. Benutzeroberfläche und Bedienung

Die Anwendung ist als **Single-Page Application (SPA)** konzipiert und läuft vollständig im Browser des Nutzers.

* **Layout:** Das Layout ist responsiv und passt sich verschiedenen Bildschirmgrößen an. Es besteht aus einem fixierten Header (auf größeren Bildschirmen), einer Tab-Navigationsleiste und dem Hauptinhaltsbereich.
* **Header:**
    * Zeigt den Anwendungstitel.
    * Stellt dynamisch aktualisierte **Schlüsselstatistiken** für das aktuell ausgewählte Kollektiv dar: Gesamtpatientenzahl (Pat.), Anteil N-positiver (N), Anteil AS-positiver (AS) und Anteil T2-positiver (T2) Patienten.
    * Enthält Buttons zur **globalen Auswahl des Patientenkollektivs**:
        * `Gesamt`: Alle 106 Patienten.
        * `Direkt OP`: Nur Patienten ohne neoadjuvante Therapie (n=29).
        * `nRCT`: Nur Patienten nach neoadjuvanter Radiochemotherapie (n=77).
        Diese Auswahl filtert die Datenbasis für alle nachfolgenden Analysen und Darstellungen in den Tabs.
* **Navigation (Tabs):** Eine horizontale Leiste ermöglicht den Wechsel zwischen den Hauptfunktionsbereichen:
    * `Patienten`: Detaillierte Patientenliste.
    * `Auswertung`: Dashboard, T2-Kriterien-Definition und -Optimierung, Ergebnisübersicht.
    * `Statistik`: Umfassende statistische Analysen und Vergleiche.
    * `Präsentation`: Aufbereitete Ergebnisse für Präsentationszwecke.
    * `Export`: Download verschiedener Analyseergebnisse und Daten.
    * `Methoden`: Detaillierte Beschreibung der Methodik der Anwendung.
* **Allgemeine UI-Elemente:**
    * **Tooltips (Tippy.js):** Fast alle interaktiven Elemente (Buttons, Spaltenköpfe, Auswahlfelder, Statistiken) verfügen über detaillierte Tooltips, die deren Funktion, Bedeutung oder die zugrundeliegende Berechnung erklären.
    * **Toast-Benachrichtigungen:** Kurze Informations-, Warn- oder Fehlermeldungen werden unten rechts auf dem Bildschirm angezeigt (z.B. nach Speichern von Kriterien, bei Exportvorgängen oder Fehlern).
    * **Modale Fenster (Bootstrap):** Werden z.B. zur Anzeige der detaillierten Brute-Force-Ergebnisse verwendet.
    * **Interaktive Tabellen:** Bieten Sortierfunktionen durch Klick auf Spaltenköpfe (inkl. Sub-Sortierung für N/AS/T2-Status) und aufklappbare Detailzeilen (Patienten- und Auswertungstab).
    * **Responsivität:** Die Darstellung passt sich dynamisch an die Bildschirmbreite an.

## 3. Datenbasis und Verarbeitung

* **Datenquelle:** Ein statischer JavaScript-Array (`patientDataRaw` in `data/data.js`), der die Daten der 106 Patienten der Avocado-Sign Studie (Lurz & Schäfer, 2025) enthält.
* **Datenmodell (pro Patient nach Verarbeitung):**
    * **Basisdaten:** `nr` (ID), `name`, `vorname` (kodiert), `geburtsdatum`, `untersuchungsdatum`, `geschlecht` ('m', 'f', oder 'unbekannt'), `alter` (berechnet).
    * **Therapie:** `therapie` ('direkt OP', 'nRCT', oder 'unbekannt').
    * **N-Status (Pathologie):** `n` ('+' oder '-'), `anzahl_patho_lk` (Gesamtzahl untersuchter LK), `anzahl_patho_n_plus_lk` (Anzahl N+ LK). Validiert als Zahl ≥ 0.
    * **AS-Status (T1KM-MRT):** `as` ('+' oder '-'), `anzahl_as_lk` (Gesamtzahl sichtbarer AS-LK), `anzahl_as_plus_lk` (Anzahl AS+ LK). Validiert als Zahl ≥ 0.
    * **T2-Lymphknoten:** `lymphknoten_t2` (Array von Objekten). Jedes Objekt repräsentiert einen im T2w-MRT sichtbaren mesorektalen Lymphknoten mit validierten Eigenschaften:
        * `groesse`: Kurzachsendurchmesser in mm (Zahl ≥ 0 oder `null`).
        * `form`: 'rund', 'oval' oder `null`.
        * `kontur`: 'scharf', 'irregulär' oder `null`.
        * `homogenitaet`: 'homogen', 'heterogen' oder `null`.
        * `signal`: 'signalarm', 'intermediär', 'signalreich' oder `null`.
    * `anzahl_t2_lk`: Anzahl valider Lymphknoten-Objekte im `lymphknoten_t2`-Array.
    * **Bemerkung:** `bemerkung` (freier Text).
    * **Dynamische T2-Bewertung (nach Anwendung von Kriterien):**
        * `t2`: Berechneter T2-Status des Patienten ('+' oder '-').
        * `anzahl_t2_plus_lk`: Anzahl der Lymphknoten dieses Patienten, die die angewendeten T2-Kriterien erfüllen.
        * `lymphknoten_t2_bewertet`: Array mit detaillierten Bewertungsergebnissen für jeden T2-Lymphknoten (inkl. `isPositive` [boolean] und `checkResult` [Objekt mit Einzelergebnissen pro Kriterium]).
* **Datenverarbeitung (`data_processor.js`):**
    * Validiert und bereinigt die Rohdaten beim Start der Anwendung.
    * Berechnet das Alter des Patienten zum Untersuchungszeitpunkt.
    * Standardisiert ungültige oder fehlende Werte (oft zu `null` oder 0 für Zählungen).
    * Stellt Funktionen zur Filterung des Datensatzes nach dem global ausgewählten Kollektiv (`Gesamt`, `direkt OP`, `nRCT`) bereit.
    * Berechnet die im Header angezeigten Übersichtsstatistiken.

## 4. Kernfunktionalitäten (pro Tab)

* **Tab: Patienten:**
    * Zeigt eine **dynamisch sortierbare Tabelle** aller Patienten des aktuell ausgewählten Kollektivs.
    * Spalten: Nr, Name, Vorname, Geschlecht, Alter, Therapie, N/AS/T2 Status (Sub-Sortierung möglich), Bemerkung.
    * **Aufklappbare Detailzeilen:** Visualisieren die morphologischen Eigenschaften (Größe, Form, Kontur, Homogenität, Signal) jedes einzelnen T2-Lymphknotens eines Patienten mittels SVG-Icons.
    * Button "Alle Details" zum globalen Ein-/Ausklappen der Details.
* **Tab: Auswertung:**
    * **Dashboard:** Zeigt eine Übersicht der wichtigsten deskriptiven Statistiken und Verteilungen (Alter, Geschlecht, Therapie, N/AS/T2-Status) als Kennzahlen und kleine Diagramme (Histogramm, Tortendiagramme via D3.js).
    * **T2-Kriterien-Definition (`t2_criteria_manager.js`):**
        * Interaktive Karte zur Definition eigener T2-Malignitätskriterien.
        * **Merkmale:** Aktivierung/Deaktivierung und Wertauswahl für Größe (≥ Schwellenwert, via Slider und Input), Form, Kontur, Homogenität, Signal (via Buttons mit Icons).
        * **Logik:** Auswahl zwischen 'UND' und 'ODER' Verknüpfung via Switch.
        * **Aktionen:** 'Anwenden & Speichern' (wendet Kriterien an, speichert sie im Local Storage, aktualisiert alle abhängigen Ansichten), 'Zurücksetzen' (setzt auf Standardwerte zurück, ohne anzuwenden).
        * **Statusanzeige:** Visuelle Hervorhebung der Karte bei ungespeicherten Änderungen.
    * **T2 Metrik-Übersicht:** Zeigt eine kompakte Zusammenfassung der diagnostischen Gütekriterien (Sens, Spez, PPV, NPV, Acc, BalAcc, F1, AUC mit CIs) für die *aktuell angewendeten* T2-Kriterien im Vergleich zum N-Status.
    * **Brute-Force-Optimierung (`brute_force_worker.js`):**
        * Karte zur Steuerung der Optimierungsfunktion.
        * Auswahl der **Zielmetrik** (Accuracy, Balanced Accuracy, F1-Score, PPV, NPV).
        * **Start/Stop:** Startet die Suche im Hintergrund (Web Worker), zeigt Fortschritt (Prozent, Anzahl getestet/gesamt, beste aktuelle Metrik/Kriterien) und ermöglicht Abbruch.
        * **Ergebnisanzeige:** Zeigt nach Abschluss das beste Ergebnis (Logik, Kriterien, Metrikwert, Dauer) an. Bietet Buttons, um das beste Ergebnis direkt anzuwenden oder die Top-10-Ergebnisse in einem Modal anzuzeigen (inkl. TXT-Exportmöglichkeit aus dem Modal).
    * **Auswertungstabelle:** Ähnlich der Patiententabelle, aber mit Fokus auf N/AS/T2-Status und Lymphknoten-Anzahlen (N+/N gesamt, AS+/AS gesamt, T2+/T2 gesamt).
        * **Aufklappbare Detailzeilen:** Zeigen die Bewertung jedes einzelnen T2-Lymphknotens gemäß den *aktuell angewendeten* Kriterien. Erfüllte Kriterien, die zur Positiv-Bewertung beitragen, sind hervorgehoben.
* **Tab: Statistik (`statistics_service.js`):**
    * Bietet tiefgehende statistische Analysen, basierend auf den **angewendeten** T2-Kriterien.
    * **Ansichtswahl:** 'Einzelansicht' (für das global gewählte Kollektiv) oder 'Vergleich Aktiv' (Auswahl zweier Kollektive für direkten Vergleich).
    * **Inhalte (pro Kollektiv bzw. im Vergleich):**
        * **Deskriptive Statistik:** Detaillierte Tabellen und Diagramme (Alter, Geschlecht).
        * **Diagnostische Güte:** Detaillierte Tabellen für AS vs. N und T2 vs. N (Sens, Spez, PPV, NPV, Acc, BalAcc, F1, AUC, jeweils mit 95% CI und Angabe der Methode). Inkl. Konfusionsmatrizen.
        * **Statistischer Vergleich (gepaart, AS vs. T2):** Tabelle mit Ergebnissen des McNemar-Tests (Accuracy) und DeLong-Tests (AUC).
        * **Assoziationsanalyse (Merkmal vs. N):** Tabelle mit OR (CI), RD (CI), Phi (φ) und p-Wert (Fisher/MWU) für AS und jedes T2-Merkmal (unabhängig von Aktivierung) in Bezug zum N-Status.
        * **Statistischer Vergleich (ungepaart, Kollektiv1 vs. Kollektiv2):** Nur in Vergleichsansicht. Tabelle mit p-Werten für den Vergleich von Accuracy (Fisher) und AUC (Z-Test) zwischen den beiden gewählten Kollektiven für AS und T2.
        * **Kriterienvergleichstabelle:** Vergleicht tabellarisch die diagnostische Güte (Sens, Spez, PPV, NPV, Acc, AUC) von AS, den aktuell angewendeten T2-Kriterien und den implementierten Literatur-Kriteriensets (Koh, Barbaro, Rutegård) für das *global* ausgewählte Kollektiv.
    * **Download-Buttons:** Ermöglichen den Export einzelner Tabellen als PNG.
* **Tab: Präsentation:**
    * Bereitet Ergebnisse für Präsentationen auf.
    * **Ansichtswahl:**
        * `Avocado Sign (Daten)`: Zeigt AS-Performance für alle Kollektive (Gesamt, Direkt OP, nRCT) in einer Tabelle und ein Detail-Performance-Diagramm für das aktuell global gewählte Kollektiv.
        * `AS vs. T2 (Vergleich)`: Ermöglicht Auswahl einer T2-Vergleichsbasis (aktuell angewandte Kriterien oder Literatur-Sets: Koh 2008, Barbaro 2024, Rutegård 2025). Zeigt:
            * Info-Karte zur T2-Vergleichsbasis (Referenz, Kriterienzusammenfassung etc.).
            * **NEU: Vergleichs-Metrik-Tabelle:** Numerische Gegenüberstellung der Gütekriterien (Sens, Spez, etc. mit CIs) von AS und der gewählten T2-Basis.
            * Statistische Tests (McNemar, DeLong) für den Vergleich AS vs. T2-Basis.
            * Vergleichs-Balkendiagramm (visuelle Darstellung der Metrik-Tabelle).
    * **Download-Buttons:** Bieten Exportmöglichkeiten für Tabellen (CSV, MD, PNG) und Charts (PNG, SVG) spezifisch für die Präsentationsansicht.
* **Tab: Export (`export_service.js`):**
    * Sammelt alle Exportoptionen an einem Ort.
    * Basiert auf dem global gewählten Kollektiv und den angewendeten T2-Kriterien.
    * **Einzel-Exporte:** Statistik-Ergebnisse (CSV), Brute-Force-Bericht (TXT), Deskriptive Statistik (MD), Patientenliste (MD), Auswertungstabelle (MD), gefilterte Rohdaten (CSV), umfassender HTML-Bericht, sichtbare Diagramme & Tabellen (PNG-ZIP), sichtbare Diagramme (SVG-ZIP).
    * **Export-Pakete (ZIP):** Bündeln alle verfügbaren Exporte oder gruppiert nach Typ (Alle CSVs, Alle MDs).
    * Hinweis-Box zu Formaten und Exportlogik.
* **Tab: Methoden:**
    * Zeigt eine **detaillierte Beschreibung** der in der Anwendung implementierten Methodik, der Datenbasis und der statistischen Verfahren (im Stil eines Publikations-Methodenteils).
    * **NEU: Sprachumschalter:** Ermöglicht den Wechsel der Beschreibung zwischen **Deutsch (de)** und **Englisch (en)**. Die Auswahl wird gespeichert.

## 5. Statistische Methoden (`statistics_service.js`)

Die Anwendung implementiert folgende statistische Verfahren:

* **Deskriptive Statistik:** Berechnung von Median, Mittelwert, Standardabweichung, Min/Max, Häufigkeiten und Prozentwerten.
* **Diagnostische Gütekriterien:** Berechnung von Sensitivität, Spezifität, PPV, NPV, Accuracy, Balanced Accuracy, F1-Score aus 2x2-Konfusionsmatrizen.
* **Konfidenzintervalle (95%):**
    * Für Proportionen (Sens, Spez, PPV, NPV, Acc): **Wilson Score Intervall**.
    * Für Effektstärken (BalAcc, F1): **Bootstrap Percentile Methode** (Standard: 1000 Replikationen).
    * Für Odds Ratio: **Woolf Logit Methode** (+0.5 Korrektur).
    * Für Risk Difference: **Wald Methode**.
* **Vergleichstests (gepaart):**
    * **McNemar-Test:** Vergleich der Accuracy von AS vs. T2.
    * **DeLong-Test:** Vergleich der AUC (BalAcc) von AS vs. T2.
* **Vergleichstests (ungepaart):**
    * **Fisher's Exact Test:** Vergleich der Accuracy zwischen zwei Kollektiven.
    * **Z-Test (basierend auf SE aus Bootstrap):** Vergleich der AUC zwischen zwei Kollektiven.
* **Assoziationstests:**
    * **Fisher's Exact Test:** Zusammenhang zwischen kategorialen Merkmalen (AS-Status, T2-Merkmale) und N-Status.
    * **Mann-Whitney-U-Test:** Vergleich der Verteilung der LK-Größe zwischen N+ und N- Patienten.
* **Assoziationsmaße:**
    * **Odds Ratio (OR)** mit 95% CI.
    * **Risk Difference (RD)** mit 95% CI.
    * **Phi-Koeffizient (φ)**.
* **Signifikanzniveau:** Standardmäßig α = 0.05.

## 6. Technologie und Architektur

* **Typ:** Reine Frontend Single-Page Application (SPA), keine Server-Komponente notwendig.
* **Kerntechnologien:** HTML5, CSS3 (mit CSS Variablen für Theming), JavaScript (ES6+).
* **Frameworks/Bibliotheken:**
    * **Bootstrap (v5.3.3):** UI-Komponenten, Layout, Grid-System, Responsivität.
    * **D3.js (v7.9.0):** Erstellung der Datenvisualisierungen (Charts).
    * **Tippy.js (v6.3.7):** Darstellung kontextsensitiver Tooltips.
    * **PapaParse (v5.4.1):** Generierung von CSV-Dateien für den Export.
    * **JSZip (v3.10.1):** Erstellung von ZIP-Archiven für gebündelte Exporte.
* **Architektur:** Modularer Aufbau zur Trennung der Verantwortlichkeiten:
    * `app/` (main.js, state.js): Anwendungssteuerung, globales State Management.
    * `config/` (config.js, texts.js): Konfiguration, UI-Texte, Tooltips.
    * `core/` (data_processor.js, t2_criteria_manager.js, study_criteria_manager.js): Kernlogik für Datenverarbeitung und Kriterienmanagement.
    * `services/` (statistics_service.js, export_service.js): Gekapselte Dienste für Statistik und Export.
    * `ui/` (ui_helpers.js, ui_components.js, table_renderer.js, chart_renderer.js, ui_view_logic.js, view_renderer.js): UI-bezogene Logik, Rendering, Komponenten.
    * `utils/` (utils.js): Allgemeine Hilfsfunktionen (Formatierung, Local Storage, etc.).
    * `workers/` (brute_force_worker.js): Auslagerung rechenintensiver Aufgaben.
* **State Management (`state.js`):** Verwaltet den Anwendungszustand (aktuelles Kollektiv, Sortierreihenfolgen, UI-Einstellungen wie Sprache) und persistiert Teile davon im Local Storage des Browsers.
* **Event Handling (`main.js`):** Nutzt Event Delegation für effizientes Event Management. Debouncing wird zur Leistungsoptimierung bei häufig ausgelösten Events (z.B. Slider-Input) eingesetzt.
* **Web Worker (`brute_force_worker.js`):** Führt die rechenintensive Brute-Force-Optimierung in einem separaten Thread aus, um die Reaktionsfähigkeit der Hauptanwendung zu gewährleisten. Kommunikation erfolgt über `postMessage` und `onmessage`.
